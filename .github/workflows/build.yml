name: Build USB-Monitor (Windows & macOS)

on:
  push:
    branches: ["main", "master"]
    tags: ["v*", "release-*", "*.*.*"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag-Name f√ºr Release (z.B. v1.0.0)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    name: Windows Build (.exe)
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') || github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build (PyInstaller)
        run: |
          python -m PyInstaller --noconfirm --onedir --windowed --name "USB-Monitor" src/main.py

      - name: Archive artifact (zip)
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/USB-Monitor" -DestinationPath "USB-Monitor-Windows.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: USB-Monitor-Windows
          path: USB-Monitor-Windows.zip

  build-macos:
    name: macOS Build (.app)
    runs-on: macos-latest
    if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') || github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build (PyInstaller)
        run: |
          python -m PyInstaller --noconfirm --onedir --windowed --name "USB-Monitor" src/main.py

      - name: Zip .app bundle
        run: |
          cd dist
          ditto -c -k --sequesterRsrc --keepParent "USB-Monitor.app" "../USB-Monitor-macOS.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: USB-Monitor-macOS
          path: USB-Monitor-macOS.zip

  release:
    if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') }}
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: USB-Monitor-Windows
          path: artifacts

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: USB-Monitor-macOS
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag != '' && github.event.inputs.release_tag || github.ref_name }}
          name: ${{ github.event.inputs.release_tag != '' && github.event.inputs.release_tag || github.ref_name }}
          files: |
            artifacts/USB-Monitor-Windows.zip
            artifacts/USB-Monitor-macOS.zip
        permissions:
          contents: write


